/*global jQuery */
/*!
 * jKerny.js
 * Version: 1.33
 * Copyright 2011 Olivier Gorzalka
 * CSS Parser adapted from the jQuery based CSS parser by Daniel Wachsstock Copyright (c) 2011
 * MIT license
 */
(function(d){function v(a){var a=l[a].replace(/^{|}$/g,""),b={},a=s(a);d.each(a.split(";"),function(a,e){e=e.split(":");2>e.length||(b[k(e[0])]=k(e.slice(1).join(":")))});return b}function s(a,b){for(var a=a.replace(w,"$1").replace(x,function(a,b){if(!b)return"";var c="%s`"+ ++m+"`s%";l[m]=b.replace(/^\\/,"");return c}),c=b?y:z;match=c.exec(a);)replacement="%b`"+ ++m+"`b%",l[m]=match[0],a=a.replace(c,replacement);return a}function k(a){if(void 0===a)return a;for(;match=t.exec(a);)a=a.replace(t,l[match[1]]); return d.trim(a)}function A(a,b){var c=a.split(/\s+/),e=c.shift();"media"==e?(e=k(c.pop()).slice(1,-1),d.parsecss.mediumApplies(c.join(" "))&&d.parsecss(e,b)):"import"==e&&(e=k(c.shift()),d.parsecss.mediumApplies(c.join(" "))&&(e=e.replace(/^url\(|\)$/gi,"").replace(/^["']|["']$/g,""),d.get(e,function(a){d.parsecss(a,b)})))}function o(a,b,c,e){var b=a.text().split(b),f="";b.length&&(d(b).each(function(a,b){f+='<span class="'+c+(a+1)+'">'+b+"</span>"+e}),a.empty().append(f))}d.parsecss=function(a, b){var c={},a=s(a).replace(/@(([^;`]|`[^b]|`b[^%])*(`b%)?);?/g,function(a,c){A(d.trim(c),b);return""});d.each(a.split("`b%"),function(a,b){b=b.split("%b`");2>b.length||(b[0]=k(b[0]),c[b[0]]=d.extend(c[b[0]]||{},v(b[1])))});b(c)};d.parsecss.mediumApplies=window.media&&window.media.query||function(a){if(!a)return!0;if(a in p)return p[a];d('<style media="'+a+'">body {position: relative; z-index: 1;}</style>').appendTo("head");return p[a]=1==d("body").css("z-index")};var p={},l={},z=/{[^{}]*}/,y=/\[[^\[\]]*\]|{[^{}]*}|\([^()]*\)|function(\s+\w+)?(\s*%b`\d+`b%){2}/, w=/\/\*@((?:[^\*]|\*[^\/])*)\*\//g,x=/(?:\/\*(?:[^\*]|\*[^\/])*\*\/)|(\\.|"(?:[^\\\"]|\\.|\\\n)*"|'(?:[^\\\']|\\.|\\\n)*')/g,t=/%\w`(\d+)`\w%/,m=0,q={init:function(){return this.each(function(){o(d(this),"","char","")})},words:function(){return this.each(function(){o(d(this)," ","word"," ")})},lines:function(){return this.each(function(){o(d(this).children("br").replaceWith("eefec303079ad17405c889e092e105b0").end(),"eefec303079ad17405c889e092e105b0","line","")})}};d.fn.lettering=function(a){if(a&& q[a])return q[a].apply(this,[].slice.call(arguments,1));if("letters"===a||!a)return q.init.apply(this,[].slice.call(arguments,0));d.error("Method "+a+" does not exist on jQuery.lettering");return this};d.jkerny_style=function(a,b){options=d.extend({type:"text/css",media:"all",styleClass:"default"},b);var c=document,e=c.createElement("style"),f="",j;for(j in a)if(a[j].hasOwnProperty){var f=f+(j+" {"),h;for(h in a[j])f+=h+":"+a[j][h]+"; ";f+="} "}c.createStyleSheet?c.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd", '&nbsp;<style class="'+options.styleClass+'" media="'+options.media+'" type="text/css">'+f+"</style>"):(e=c.createElement("style"),e.type="text/css",e.media=options.media,e.className=options.styleClass,e.appendChild(c.createTextNode(f)),c.getElementsByTagName("head")[0].appendChild(e))};var u={":unknown":"",":((first|last)(-))?(letter|word)":"._$2$3$4","._(letter|word):(first|last)-child":"._$2-$1","._((last|first)-)letter":"span.jkerny-word:$2-child span.jkerny-letter:$2-child","._((last|first)-)word":"span.jkerny-word:$2-child", "._(letter|word)":"span.jkerny-$1","(span.jkerny-word([^ ]*)?) *span.jkerny-word:(first|last)-child":"$1"},r=/(>|~|\+)? span.jkerny-(letter|word)/gi,g="all",n=0,i={};d.jkerny={run:function(){var a=this;d.jkerny_style({"span.jkerny-word, span.jkerny-letter":{display:"inline-block"},".jkerny":{visibility:"inherit"}},{styleClass:"jkerny"});d("style:not(.jkerny),link[rel=stylesheet]").each(function(){i[g]={};this.href&&!this.disabled&&!(0>this.href.indexOf("//"+window.location.host)&&/^\w+:/.test(this.href))? d.ajax({url:this.href,success:function(b){g="undefined"==typeof d(this).attr("media")?"all":d(this).attr("media");a.parseCss(b)}}):(g="undefined"==typeof d(this).attr("media")?"all":d(this).attr("media"),a.parseCss(d(this).removeAttr("type").html()))})},parseMediaQueries:function(a){if(a=a.match(RegExp(/@media([^\{]+)\{([^\{\}]+\{[^\}\{]+\})+/),"gi"))for(var b=0;b<a.length;b++)g=d.trim(a[1]),"undefined"==typeof i[g]&&(i[g]={}),this.parseCss(a[2],!0)},parseCss:function(a,b){var c=this,e=b||!1,a=c.convertPseudoSelectors(a); d.parsecss(a,function(a){selectors=c.filterSelectors(a);c.proceedCss(selectors)});!1===e&&c.parseMediaQueries(a)},convertPseudoSelectors:function(a){for(var b in u)a=a.replace(RegExp(b,"gi")," "+u[b]);return a},getLength:function(a){var b=0,c;for(c in a)b++;return b},applyProperties:function(a,b){var c,e,f,j,h;j=b.split(",");for(h=0;h<j.length;h++)j[h].replace(RegExp(":(hover|enabled|disabled|focus|checked|target|active|visited|after|before)","gi"),"").split(r),c=d(j[h].replace(RegExp(":(hover|enabled|disabled|focus|checked|target|active|visited|after|before)", "gi"),"")),f=c.is(".jkerny-letter")?"letter":"word",e=j[h].replace(RegExp("span.jkerny-(letter|word)(:(eq|empty|(first|last|only|nth(-last)?)-(child|of-type))([^\\)]*\\))?)?","gi"),".jkerny-$1-"+n),c.addClass("jkerny-"+f+"-"+n).parent(".jkerny-word").addClass("jkerny-word-"+n),i[g][e]=a[b];n++},proceedCss:function(a){var b,c,e;if(0<this.getLength(a))for(var f in a){b=f.split(",");for(e=0;e<b.length;e++)c=d(b[e].replace(RegExp(":(hover|enabled|disabled|focus|checked|target|active|visited|after|before)", "gi"),"").split(r)[0]),c.not(".jkerny").addClass("jkerny").lettering("words").children("span").addClass("jkerny-word").lettering().children("span").addClass("jkerny-letter");this.applyProperties(a,f)}0<this.getLength(i[g])&&(d.jkerny_style(i[g],{media:g,styleClass:"jkerny"}),i[g]={})},filterSelectors:function(a){var b={},c=[],d,f,j,h,g,i;for(i in a){-1<i.indexOf("jkerny-")&&(b[i]=a[i]);for(var k in a[i])if(d=k.match(RegExp(/-jkerny-(letter|word)-spacing/),"gi")){c=a[i][d[0]].replace(/[\n\s]+/g," ").split(" "); f=i.split(",");for(h=0;h<f.length;h++)for(g=0;g<c.length;g++)j=f[h].replace(RegExp(":(hover|enabled|disabled|focus|checked|target|active|visited|after|before)","gi"),"").split(r)[0],b[j+" span.jkerny-"+d[1]+":eq("+g+")"]={"margin-right":c[g]}}}return b}};d(function(){d.jkerny.run()})})(jQuery);