/*global jQuery */
/*!
 * jKerny.js
 * Version: 1.32
 * Copyright 2011 Olivier Gorzalka
 * CSS Parser adapted from the jQuery based CSS parser by Daniel Wachsstock Copyright (c) 2011
 * MIT license
 */
(function(e){function q(a){var a=i[a].replace(/^{|}$/g,""),a=o(a),b={};e.each(a.split(";"),function(a,d){d=d.split(":");2>d.length||(b[g(d[0])]=g(d.slice(1).join(":")))});return b}function o(a,b){for(var a=a.replace(r,"$1").replace(s,function(a,c){if(!c)return"";var b="%s`"+ ++k+"`s%";i[k]=c.replace(/^\\/,"");return b}),c=b?t:u;match=c.exec(a);)replacement="%b`"+ ++k+"`b%",i[k]=match[0],a=a.replace(c,replacement);return a}function g(a){if(void 0===a)return a;for(;match=p.exec(a);)a=a.replace(p,i[match[1]]); return e.trim(a)}function v(a,b){var c=a.split(/\s+/),d=c.shift();"media"==d?(d=g(c.pop()).slice(1,-1),e.parsecss.mediumApplies(c.join(" "))&&e.parsecss(d,b)):"import"==d&&(d=g(c.shift()),e.parsecss.mediumApplies(c.join(" "))&&(d=d.replace(/^url\(|\)$/gi,"").replace(/^["']|["']$/g,""),e.get(d,function(a){e.parsecss(a,b)})))}function l(a,b,c,d){var b=a.text().split(b),f="";b.length&&(e(b).each(function(a,b){f+='<span class="'+c+(a+1)+'">'+b+"</span>"+d}),a.empty().append(f))}e.parsecss=function(a, b){var c={},a=o(a).replace(/@(([^;`]|`[^b]|`b[^%])*(`b%)?);?/g,function(a,c){v(e.trim(c),b);return""});e.each(a.split("`b%"),function(a,b){b=b.split("%b`");2>b.length||(b[0]=g(b[0]),c[b[0]]=e.extend(c[b[0]]||{},q(b[1])))});b(c)};e.parsecss.mediumApplies=window.media&&window.media.query||function(a){if(!a)return!0;if(a in m)return m[a];e('<style media="'+a+'">body {position: relative; z-index: 1;}</style>').appendTo("head");return m[a]=1==e("body").css("z-index")};var m={},i={},u=/{[^{}]*}/,t=/\[[^\[\]]*\]|{[^{}]*}|\([^()]*\)|function(\s+\w+)?(\s*%b`\d+`b%){2}/, r=/\/\*@((?:[^\*]|\*[^\/])*)\*\//g,s=/(?:\/\*(?:[^\*]|\*[^\/])*\*\/)|(\\.|"(?:[^\\\"]|\\.|\\\n)*"|'(?:[^\\\']|\\.|\\\n)*')/g,p=/%\w`(\d+)`\w%/,k=0,n={init:function(){return this.each(function(){l(e(this),"","char","")})},words:function(){return this.each(function(){l(e(this)," ","word"," ")})},lines:function(){return this.each(function(){l(e(this).children("br").replaceWith("eefec303079ad17405c889e092e105b0").end(),"eefec303079ad17405c889e092e105b0","line","")})}};e.fn.lettering=function(a){if(a&& n[a])return n[a].apply(this,[].slice.call(arguments,1));if("letters"===a||!a)return n.init.apply(this,[].slice.call(arguments,0));e.error("Method "+a+" does not exist on jQuery.lettering");return this};e.style=function(a,b){options=e.extend({type:"text/css",media:"all",styleClass:"default"},b);var c=document,d=c.createElement("style"),f="",h;for(h in a)if(a[h].hasOwnProperty){var f=f+(h+" {"),j;for(j in a[h])f+=j+":"+a[h][j]+"; ";f+="} "}c.createStyleSheet?c.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd", '&nbsp;<style class="'+options.styleClass+'" media="'+options.media+'" type="text/css">'+f+"</style>"):(d=c.createElement("style"),d.type="text/css",d.media=options.media,d.className=options.styleClass,d.appendChild(c.createTextNode(f)),c.getElementsByTagName("head")[0].appendChild(d))};e.jkerny={lettering_replace:{":unknown":"",":((first|last)(-))?(letter|word)":"._$2$3$4","._(letter|word):(first|last)-child":"._$2-$1","._((last|first)-)letter":"span.jkerny-word:$2-child span.jkerny-letter:$2-child", "._((last|first)-)word":"span.jkerny-word:$2-child","._(letter|word)":"span.jkerny-$1","(span.jkerny-word([^ ]*)?) *span.jkerny-word:(first|last)-child":"$1"},pseudo_structural:":(empty|(first|last|only|nth(-last)?)-(child|of-type))([^\\)]*\\))?",pseudo_selectors:":(hover|enabled|disabled|focus|checked|target|active|visited|after|before)",split_expr:/(>|~|\+)? span.jkerny-(letter|word)/gi,medias_screen:"all",kerning_counter:0,output:{},run:function(){var a=this;e.style({"span.jkerny-word, span.jkerny-letter":{display:"inline-block"}, ".jkerny":{visibility:"inherit"}},{styleClass:"jkerny"});e("style:not(.jkerny),link[rel=stylesheet]").each(function(){a.medias_screen="undefined"==typeof e(this).attr("media")?"all":e(this).attr("media");a.output[a.medias_screen]={};this.href&&!this.disabled&&!(0>this.href.indexOf("//"+window.location.host)&&/^\w+:/.test(this.href))?e.ajax({url:this.href,success:function(b){a.parseCss(b)}}):a.parseCss(e(this).removeAttr("type").html())})},parseMediaQueries:function(a){var b,c=a.match(/@media[^\{]+\{([^\{\}]+\{[^\}\{]+\})+/gi), d;for(d in c)b=a.match(RegExp(/@media([^\{]+)\{([^\{\}]+\{[^\}\{]+\})+/),"gi"),this.medias_screen=e.trim(b[1]),"undefined"==typeof this.output[this.medias_screen]&&(this.output[this.medias_screen]={}),this.parseCss(b[2],!0)},parseCss:function(a,b){var c=this,d=b||!1,a=c.convertPseudoSelectors(a);e.parsecss(a,function(a){selectors=c.filterSelectors(a);c.proceedCss(selectors)});!1===d&&c.parseMediaQueries(a)},convertPseudoSelectors:function(a){for(var b in this.lettering_replace)a=a.replace(RegExp(b, "gi")," "+this.lettering_replace[b]);return a},getLength:function(a){var b=0,c;for(c in a)b++;return b},applyProperties:function(a,b,c){var d,f,h,j;j=b.split(",");for(var g=0;g<j.length;g++)if(f=j[g].replace(RegExp(this.pseudo_selectors),"").split(this.split_expr)[0],"pseudo-selector"==c)d=e(j[g].replace(RegExp(this.pseudo_selectors),"")),h=d.is(".jkerny-letter")?"letter":"word",f=j[g].replace(RegExp("span.jkerny-(letter|word)("+this.pseudo_structural+")?","gi"),".jkerny-$1-"+this.kerning_counter), d.addClass("jkerny-"+h+"-"+this.kerning_counter).parent(".jkerny-word").addClass("jkerny-word-"+this.kerning_counter),this.output[this.medias_screen][f]=a[b],this.kerning_counter++;else if("undefined"!=typeof a[b]["-jkerny-"+c+"-spacing"]){h=a[b]["-jkerny-"+c+"-spacing"].replace(/[\n\s]+/g," ").split(" ");for(var i=0;i<h.length;i++)d=e(f).find("span.jkerny-"+c+":eq("+i+")"),d.addClass("kerning-"+this.kerning_counter),this.output[this.medias_screen][f+" .jkerny-"+c+".kerning-"+this.kerning_counter]= {"margin-right":h[i]},this.kerning_counter++}},proceedCss:function(a){var b,c;if(0<this.getLength(a))for(var d in a){b=d.split(",");for(var f=0;f<b.length;f++)c=e(b[f].replace(RegExp(this.pseudo_selectors),"").split(this.split_expr)[0]),c.not(".jkerny").addClass("jkerny").lettering("words").children("span").addClass("jkerny-word").lettering().children("span").addClass("jkerny-letter");this.applyProperties(a,d,"word");this.applyProperties(a,d,"letter");this.applyProperties(a,d,"pseudo-selector")}0< this.getLength(this.output[this.medias_screen])&&(e.style(this.output[this.medias_screen],{media:this.medias_screen,styleClass:"jkerny"}),this.output[this.medias_screen]={})},filterSelectors:function(a){var b={},c;for(c in a)if(-1<c.indexOf("jkerny-"))b[c]=a[c];else for(var d in a[c])-1<d.indexOf("jkerny-")&&(b[c]=a[c]);return b}};e(function(){e.jkerny.run()})})(jQuery);