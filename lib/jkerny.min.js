/*global jQuery */
/*!
 * jKerny.js
 * Version: 1.3
 * Copyright 2011 Olivier Gorzalka
 * CSS Parser adapted from the jQuery based CSS parser by Daniel Wachsstock Copyright (c) 2011
 * MIT license
 */
(function(d){function q(a){var a=i[a].replace(/^{|}$/g,""),a=o(a),b={};d.each(a.split(";"),function(a,e){e=e.split(":");2>e.length||(b[g(e[0])]=g(e.slice(1).join(":")))});return b}function o(a,b){for(var a=a.replace(r,"$1").replace(s,function(a,c){if(!c)return"";var b="%s`"+ ++k+"`s%";i[k]=c.replace(/^\\/,"");return b}),c=b?t:u;match=c.exec(a);)replacement="%b`"+ ++k+"`b%",i[k]=match[0],a=a.replace(c,replacement);return a}function g(a){if(void 0===a)return a;for(;match=p.exec(a);)a=a.replace(p,i[match[1]]); return d.trim(a)}function v(a,b){var c=a.split(/\s+/),e=c.shift();"media"==e?(e=g(c.pop()).slice(1,-1),d.parsecss.mediumApplies(c.join(" "))&&d.parsecss(e,b)):"import"==e&&(e=g(c.shift()),d.parsecss.mediumApplies(c.join(" "))&&(e=e.replace(/^url\(|\)$/gi,"").replace(/^["']|["']$/g,""),d.get(e,function(a){d.parsecss(a,b)})))}function l(a,b,c,e){var b=a.text().split(b),f="";b.length&&(d(b).each(function(a,b){f+='<span class="'+c+(a+1)+'">'+b+"</span>"+e}),a.empty().append(f))}d.parsecss=function(a, b){var c={},a=o(a).replace(/@(([^;`]|`[^b]|`b[^%])*(`b%)?);?/g,function(a,c){v(d.trim(c),b);return""});d.each(a.split("`b%"),function(a,b){b=b.split("%b`");2>b.length||(b[0]=g(b[0]),c[b[0]]=d.extend(c[b[0]]||{},q(b[1])))});b(c)};d.parsecss.mediumApplies=window.media&&window.media.query||function(a){if(!a)return!0;if(a in m)return m[a];d('<style media="'+a+'">body {position: relative; z-index: 1;}</style>').appendTo("head");return m[a]=1==d("body").css("z-index")};var m={},i={},u=/{[^{}]*}/,t=/\[[^\[\]]*\]|{[^{}]*}|\([^()]*\)|function(\s+\w+)?(\s*%b`\d+`b%){2}/, r=/\/\*@((?:[^\*]|\*[^\/])*)\*\//g,s=/(?:\/\*(?:[^\*]|\*[^\/])*\*\/)|(\\.|"(?:[^\\\"]|\\.|\\\n)*"|'(?:[^\\\']|\\.|\\\n)*')/g,p=/%\w`(\d+)`\w%/,k=0,n={init:function(){return this.each(function(){l(d(this),"","char","")})},words:function(){return this.each(function(){l(d(this)," ","word"," ")})},lines:function(){return this.each(function(){l(d(this).children("br").replaceWith("eefec303079ad17405c889e092e105b0").end(),"eefec303079ad17405c889e092e105b0","line","")})}};d.fn.lettering=function(a){if(a&& n[a])return n[a].apply(this,[].slice.call(arguments,1));if("letters"===a||!a)return n.init.apply(this,[].slice.call(arguments,0));d.error("Method "+a+" does not exist on jQuery.lettering");return this};d.style=function(a,b){options=d.extend({type:"text/css",media:"all",styleClass:"default"},b);var c=document,e=c.createElement("style"),f="",h;for(h in a)if(a[h].hasOwnProperty){var f=f+(h+" {"),j;for(j in a[h])f+=j+":"+a[h][j]+"; ";f+="} "}c.createStyleSheet?c.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd", '&nbsp;<style class="'+options.styleClass+'" media="'+options.media+'" type="text/css">'+f+"</style>"):(e=c.createElement("style"),e.type="text/css",e.media=options.media,e.className=options.styleClass,e.appendChild(c.createTextNode(f)),c.getElementsByTagName("head")[0].appendChild(e))};d.jkerny={lettering_replace:{":unknown":"",":((first|last)(-))?(letter|word)":"._$2$3$4","._(letter|word):(first|last)-child":"._$2-$1","._((last|first)-)letter":"span.jkerny-word:$2-child span.jkerny-letter:$2-child", "._((last|first)-)word":"span.jkerny-word:$2-child","._(letter|word)":"span.jkerny-$1","(span.jkerny-word([^ ]*)?) *span.jkerny-word:(first|last)-child":"$1"},pseudo_structural:":(empty|(first|last|only|nth(-last)?)-(child|of-type))([^\\)]*\\))?",pseudo_selectors:":(hover|enabled|disabled|focus|checked|target|active|visited|after|before)",split_expr:/(>|~|\+)? span.jkerny-(letter|word)/gi,medias_screen:"all",kerning_counter:0,output:{},run:function(){var a=this;d.style({"span.jkerny-word, span.jkerny-letter":{display:"inline-block"}, ".jkerny":{visibility:"inherit"}},{styleClass:"jkerny"});d("style:not(.jkerny),link[rel=stylesheet]").each(function(){a.medias_screen="undefined"==typeof d(this).attr("media")?"all":d(this).attr("media");a.output[a.medias_screen]={};this.href&&!this.disabled&&!(0>this.href.indexOf("//"+window.location.host)&&/^\w+:/.test(this.href))?d.ajax({url:this.href,success:function(b){a.parseCss(b)}}):a.parseCss(d(this).removeAttr("type").html())})},parseMediaQueries:function(a){var b,c=a.match(/@media[^\{]+\{([^\{\}]+\{[^\}\{]+\})+/gi), e;for(e in c)b=a.match(RegExp(/@media([^\{]+)\{([^\{\}]+\{[^\}\{]+\})+/),"gi"),this.medias_screen=d.trim(b[1]),"undefined"==typeof this.output[this.medias_screen]&&(this.output[this.medias_screen]={}),this.parseCss(b[2],!0)},parseCss:function(a,b){var c=this,e=b||!1,a=c.convertPseudoSelectors(a);d.parsecss(a,function(a){selectors=c.filterSelectors(a);c.proceedCss(selectors)});!1===e&&c.parseMediaQueries(a)},convertPseudoSelectors:function(a){for(var b in this.lettering_replace)a=a.replace(RegExp(b, "gi")," "+this.lettering_replace[b]);return a},getLength:function(a){var b=0,c;for(c in a)b++;return b},applyProperties:function(a,b,c){var e,f,h,j;j=b.split(",");for(var g=0;g<j.length;g++)if(f=j[g].replace(RegExp(this.pseudo_selectors),"").split(this.split_expr)[0],"pseudo-selector"==c)e=d(j[g].replace(RegExp(this.pseudo_selectors),"")),h=e.is(".jkerny-letter")?"letter":"word",f=j[g].replace(RegExp("span.jkerny-(letter|word)("+this.pseudo_structural+")?","gi"),".jkerny-$1-"+this.kerning_counter), e.addClass("jkerny-"+h+"-"+this.kerning_counter).parent(".jkerny-word").addClass("jkerny-word-"+this.kerning_counter),this.output[this.medias_screen][f]=a[b],this.kerning_counter++;else if("undefined"!=typeof a[b]["-jkerny-"+c+"-spacing"]){h=a[b]["-jkerny-"+c+"-spacing"].replace(/[\n\s]+/g," ").split(" ");for(var i=0;i<h.length;i++)e=d(f).find("span.jkerny-"+c+":eq("+i+")"),e.addClass("kerning-"+this.kerning_counter),this.output[this.medias_screen][f+" .jkerny-"+c+".kerning-"+this.kerning_counter]= {"margin-right":h[i]},this.kerning_counter++}},proceedCss:function(a){if(0<this.getLength(a))for(var b in a){var c=b.replace(RegExp(this.pseudo_selectors),"").split(this.split_expr)[0];d(c).not(".jkerny").addClass("jkerny").lettering("words").children("span").addClass("jkerny-word").lettering().children("span").addClass("jkerny-letter");this.applyProperties(a,b,"word");this.applyProperties(a,b,"letter");this.applyProperties(a,b,"pseudo-selector")}0<this.getLength(this.output[this.medias_screen])&& d.style(this.output[this.medias_screen],{media:this.medias_screen,styleClass:"jkerny"})},filterSelectors:function(a){var b={},c;for(c in a)if(-1<c.indexOf("jkerny-"))b[c]=a[c];else for(var d in a[c])-1<d.indexOf("jkerny-")&&(b[c]=a[c]);return b}};d(function(){d.jkerny.run()})})(jQuery);