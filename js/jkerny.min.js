/*global jQuery */
/*!
 * jKerny.js
 * Version: 0.1
 * Copyright 2011 Olivier Gorzalka
 * CSS Parser adapted from JSS by Andy Kent
 * MIT license
 */
(function(a){function b(b,c,d,e){var f=b.text().split(c),g="";if(f.length){a(f).each(function(a,b){g+='<span class="'+d+(a+1)+'">'+b+"</span>"+e});b.empty().append(g)}}var d={init:function(){return this.each(function(){b(a(this),"","char","")})},words:function(){return this.each(function(){b(a(this)," ","word"," ")})},lines:function(){return this.each(function(){var c="eefec303079ad17405c889e092e105b0";b(a(this).children("br").replaceWith(c).end(),c,"line","")})}};a.fn.lettering=function(b){if(b&&d[b]){return d[b].apply(this,[].slice.call(arguments,1))}else if(b==="letters"||!b){return d.init.apply(this,[].slice.call(arguments,0))}a.error("Method "+b+" does not exist on jQuery.lettering");return this};a.jkerny={loadExternalStyles:true,exclude:[],lettering_replace:{":letter":"span[class^=char]",":word":"span[class^=word]",":first-word":"span[class^=word]:first",":last-word":"span[class^=word]:last",":first-letter":"span[class^=char]:first",":last-letter":"span[class^=char]:last"},only_selectors:[/span\[class\^=(word|char)\]/],only_properties:[/-jkerny-(word|letter)-spacing/],disableCaching:true,checkMediaTypes:true,cache:{},loadQueue:[],completeQueue:[],media:{},testDiv:null,run:function(b){var c=[];var d=this;a("style,link[rel=stylesheet]").each(function(){if(d.checkMediaTypes){if(!d.mediumApplies(this.media))return}if(this.href){if(d.loadExternalStyles){d.loadQueue.push(this.href);d.loadStylesFrom(this.href)}}else{b=d.convertPseudoSelectors(this.innerHTML);c=c.concat(d.parse(b));d.proceedLettering(c)}});if(b){c.concat(this.parse(b))}c=this.filterSelectors(c);this.runSelectors(c)},convertPseudoSelectors:function(a){var b=this;for(var c in b.lettering_replace){a=a.replace(new RegExp(c,"g")," "+b.lettering_replace[c])}return a},loadStylesFrom:function(b){var c=this;a.ajax({url:b,success:function(a){content=c.convertPseudoSelectors(a);c.refreshLoadQueue(b,content)}})},refreshLoadQueue:function(a,b){if(this.loadQueue.length==0)return;if(a){if(a==this.loadQueue[0]){this.loadQueue.shift();this.runStylesFromText(b);this.refreshLoadQueue()}else{this.completeQueue.push({href:a,txt:b});this.refreshLoadQueue()}}else{if(this.completeQueue.length>0){for(i in this.completeQueue){var c=this.completeQueue[i];if(c.href==this.loadQueue[0]){this.loadQueue.shift();this.completeQueue.splice(i,1);this.runStylesFromText(c.txt);this.refreshLoadQueue()}}}}},runStylesFromText:function(a){var b=this,c=this.filterSelectors(this.parse(a));this.runSelectors(c);b.proceedLettering(c)},applyCss:function(b,c,d){if(d===true){var e=b.split(":hover"),f=a(e[0]),g=a(b.replace(":hover",""));f.on("mouseenter",function(){g=a.trim(e[1])!=""?a(this).find(a.trim(e[1])):a(this);g.data({"default-style":g.attr("style")}).css(c)});f.on("mouseleave",function(){g=a.trim(e[1])!=""?a(this).find(a.trim(e[1])):a(this);g.attr("style",g.data("default-style"))})}else{a(b).css(c)}},proceedLettering:function(b){var c=this;a.each(b,function(){var b=this,d=a(b.selector.replace(":hover","").split(/ span\[class\^=(char|word)\]/g)[0]),e=false;d.not(".jkerny").addClass("jkerny").css("visibility","inherit").lettering("words").children("span").css("display","inline-block").lettering().children("span").css("display","inline-block");if(b.selector.indexOf(":hover")>-1){e=true}if(typeof b.attributes["-jkerny-letter-spacing"]!="undefined"){var f=b.attributes["-jkerny-letter-spacing"].replace(/[\n\s]+/g," ").split(" ");for(var g=0;g<=f.length;g++){c.applyCss(b.selector+" span[class^=word] span:eq("+g+")",{marginRight:f[g]},e)}}if(typeof b.attributes["-jkerny-word-spacing"]!="undefined"){var f=b.attributes["-jkerny-word-spacing"].replace(/[\n\s]+/g," ").split(" ");for(var g=1;g<=f.length;g++){d.find("span.word"+g).css({marginRight:f[g-1]})}}a.each(c.only_selectors,function(){if(b.selector.match(this)){c.applyCss(b.selector,b.attributes,e)}})})},runSelectors:function(b){var c=this,d=null;a.each(b,function(){if(c.isUnderstoodSelector(this.selector))return;if(c.disableCaching)return a(this.selector).css(this.attributes);if(c.cache[this.selector]){c.cache[this.selector].css(this.attributes)}else if(d=c.scanCache(this.selector)){d[0].find(d[1]).css(this.attributes)}else{c.cache[this.selector]=a(this.selector).css(this.attributes)}})},scanCache:function(a){for(var b in this.cache){if(a.search(new RegExp("^"+b+"[ >]"))>-1)return[this.cache[b],a.replace(new RegExp("^"+b+"[ >]"),"")]}},filterSelectors:function(a){if(!a.length)return[];var b=a;if(this.only_selectors&&this.only_selectors.length||this.only_properties&&this.only_properties.length){var c=this.only_selectors,d=this.only_properties,e=[],f=[];for(var g=0;g<c.length;g++){for(var h=0;h<b.length;h++){if(typeof c[g]=="string"?b[h].selector==c[g]:b[h].selector.match(c[g])){e.push(b[h]);f.push(b[h].selector)}}}for(var g=0;g<d.length;g++){for(var h=0;h<b.length;h++){for(attribute in b[h].attributes){if(typeof d[g]=="string"?attribute.selector==d[g]:attribute.match(d[g])&&jQuery.inArray(b[h].selector,f)<0){e.push(b[h]);continue}}}}b=e}if(this.exclude&&this.exclude.length){var i=this.exclude;for(var g=0;g<i.length;g++){for(var h=0;h<b.length;h++){if(typeof i[g]=="string"?b[h].selector==i[g]:b[h].selector.match(i[g])){b.splice(h,1);h--}}}}return b},isUnderstoodSelector:function(b){var c;b+="{}";var d=a('<style type="text/css"/>').appendTo("head")[0];try{d.appendChild(document.createTextNode(""))}catch(e){}if(d.styleSheet){d.styleSheet.cssText=b;c=!/UNKNOWN/i.test(d.styleSheet.cssText)}else if(d.sheet){try{d.sheet.insertRule(b,0);c=d.sheet.cssRules.length>0}catch(e){c=false}}a(d).remove();return c},mediumApplies:function(b){if(!b)return true;if(b in this.media)return this.media[b];if(!this.testDiv){this.testDiv=a('<div id="mediaTestDiv" style="position:relative">').append("<div>").appendTo("body")}var c=a('<style type="text/css" media="'+b+'" />').appendTo("head")[0];try{c.appendChild(document.createTextNode(""))}catch(d){}if(c.styleSheet){c.styleSheet.addRule("#mediaTestDiv","left: 1px")}else if(c.sheet){c.sheet.insertRule("#mediaTestDiv {left: 1px}",0)}this.media[b]=this.testDiv.css("left")=="1px";a(c).remove();return this.media[b]},sanitize:function(a){if(!a)return"";var b=a.replace(/[\n\r]/gi,"");b=b.replace(/\/\*.+?\*\//gi,"");return b},parse:function(a){var b=this.sanitize(a),c=[];b=b.match(/.+?\{.+?\}/gi);if(!b)return[];for(var d=0;d<b.length;d++)if(b[d])c.push({selector:this.parseSelectorName(b[d]),attributes:this.parseAttributes(b[d])});return c},parseSelectorName:function(b){return a.trim(b.match(/^.+?\{/)[0].replace("{",""))},parseAttributes:function(b){var d={};c=b.match(/\{.+?\}/)[0].replace(/[\{\}]/g,"").split(";").slice(0,-1);for(var e=0;e<c.length;e++){if(c[e]){c[e]=c[e].split(":");d[a.trim(c[e][0])]=a.trim(c[e][1])}}return d}}})(jQuery);$(document).ready(function(){$.jkerny.run()})